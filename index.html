<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Virtual Chemistry Lab â€” Realistic (Single Page)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg1: #ffffff;
        --bg2: #eef1f6;
        --ink: #0f172a;
        --muted: #667085;
        --accent: #ff2d55;

        --card: #0b1220;
        --card2: #111a2e;

        --stroke: rgba(15, 23, 42, 0.12);
        --shadow: 0 18px 40px rgba(2, 6, 23, 0.12);
        --shadow2: 0 10px 24px rgba(2, 6, 23, 0.12);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family:
          Poppins,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
        color: var(--ink);
        background: radial-gradient(
          1200px 520px at 50% 20%,
          var(--bg1),
          var(--bg2)
        );
        overflow: auto; /* âœ… allow scroll */
      }

      .vlab {
        min-height: 100vh;
        padding: 16px 16px 18px;
        position: relative;
        overflow: visible; /* âœ… allow scroll */
      }

      /* Top bar */
      .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 6px 4px 12px;
        position: sticky;
        top: 0;
        z-index: 60;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.95),
          rgba(255, 255, 255, 0.7)
        );
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      }
      .brand {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 0 6px rgba(255, 45, 85, 0.1);
      }
      .h1 {
        font-weight: 600;
        font-size: 18px;
        line-height: 1.1;
      }
      .sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }

      .actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .btn {
        border: 0;
        background: #fff;
        height: 42px;
        padding: 0 14px;
        border-radius: 14px;
        box-shadow: var(--shadow2);
        color: var(--ink);
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        user-select: none;
        white-space: nowrap;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.icon {
        width: 42px;
        padding: 0;
        justify-content: center;
        font-size: 18px;
      }
      .chip {
        height: 42px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow2);
        font-size: 12px;
        color: var(--muted);
        user-select: none;
        white-space: nowrap;
      }
      .chip strong {
        color: var(--ink);
        font-weight: 600;
      }

      /* âœ… PANEL TOGGLE BUTTON (black container becomes a button when collapsed) */
      .panelToggle {
        position: sticky;
        top: 62px;
        z-index: 55;
        display: flex;
        justify-content: center;
        margin: 10px 0 0;
        pointer-events: none;
      }
      .panelToggle .ptBtn {
        pointer-events: auto;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(180deg, var(--card), var(--card2));
        color: #e6eaf2;
        border-radius: 999px;
        height: 44px;
        padding: 0 14px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--shadow);
        cursor: pointer;
        user-select: none;
        max-width: min(760px, 100%);
      }
      .ptDot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(52, 211, 153, 0.95);
        box-shadow: 0 0 0 6px rgba(52, 211, 153, 0.12);
        flex: 0 0 auto;
      }
      .ptText {
        font-size: 12px;
        opacity: 0.92;
      }
      .ptText strong {
        color: #fff;
        font-weight: 700;
      }
      .ptHint {
        font-size: 12px;
        opacity: 0.72;
        margin-left: 6px;
      }
      .ptBtn:active {
        transform: translateY(1px);
      }

      /* Floating panel (can collapse) */
      .panel {
        width: min(860px, calc(100% - 0px));
        margin: 10px auto 0;
        background: linear-gradient(180deg, var(--card), var(--card2));
        border-radius: 18px;
        box-shadow: var(--shadow);
        color: #e6eaf2;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow: hidden;
        z-index: 18;
        transition:
          max-height 0.22s ease,
          opacity 0.22s ease,
          transform 0.22s ease;
        max-height: 420px;
      }
      .panel.is-collapsed {
        max-height: 0;
        opacity: 0;
        transform: translateY(-8px);
        border: 0;
        margin: 0 auto;
        box-shadow: none;
      }

      .tabs {
        display: flex;
        gap: 8px;
        padding: 10px 12px 0;
        align-items: center;
        justify-content: space-between;
      }
      .tabsLeft {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .tab {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: transparent;
        color: #e6eaf2;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
        letter-spacing: 0.4px;
        user-select: none;
      }
      .tab.is-active {
        border-color: rgba(255, 45, 85, 0.55);
        box-shadow: 0 0 0 4px rgba(255, 45, 85, 0.1) inset;
      }

      .miniStats {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
        color: rgba(230, 234, 242, 0.85);
        font-size: 12px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        user-select: none;
      }
      .dotSm {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(52, 211, 153, 0.9);
        box-shadow: 0 0 0 5px rgba(52, 211, 153, 0.12);
      }
      .dotSm.hot {
        background: rgba(255, 176, 0, 0.95);
        box-shadow: 0 0 0 5px rgba(255, 176, 0, 0.14);
      }
      .dotSm.warn {
        background: rgba(255, 45, 85, 0.95);
        box-shadow: 0 0 0 5px rgba(255, 45, 85, 0.14);
      }

      .panelBody {
        padding: 10px 14px 14px;
      }
      .panelBody.is-hidden {
        display: none;
      }

      .thead {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr 0.8fr 0.8fr;
        gap: 10px;
        color: rgba(230, 234, 242, 0.82);
        font-size: 12px;
        padding: 6px 2px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .rows {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 10px;
        min-height: 56px;
      }
      .row {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr 0.8fr 0.8fr;
        gap: 10px;
        align-items: center;
        font-size: 13px;
      }
      .row .chem {
        color: #fff;
        font-weight: 500;
      }
      .right {
        text-align: right;
      }
      .hint {
        margin-top: 10px;
        font-size: 12px;
        color: rgba(230, 234, 242, 0.7);
        line-height: 1.35;
      }

      .rxnList {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding-top: 6px;
      }
      .rxnItem {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 10px 12px;
      }
      .rxnTitle {
        font-size: 13px;
        font-weight: 800;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .rxnTag {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        font-weight: 700;
        letter-spacing: 0.35px;
        opacity: 0.95;
      }
      .rxnEq {
        font-size: 12px;
        color: rgba(230, 234, 242, 0.88);
        margin-top: 6px;
        line-height: 1.35;
      }
      .rxnNote {
        font-size: 12px;
        color: rgba(230, 234, 242, 0.7);
        margin-top: 6px;
      }
      .rxnMini {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
        font-size: 11px;
        color: rgba(230, 234, 242, 0.85);
      }
      .rxnMini .pill {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 999px;
        padding: 6px 10px;
      }

      /* Main layout */
      .layout {
        display: grid;
        grid-template-columns: 280px 1fr 280px;
        gap: 14px;
        margin-top: 14px;
        align-items: stretch;
      }

      .side {
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-width: 260px;
      }

      .box {
        background: rgba(255, 255, 255, 0.72);
        border: 1px solid var(--stroke);
        border-radius: 18px;
        box-shadow: var(--shadow2);
        padding: 12px;
        overflow: hidden;
        min-height: 0;
      }

      .boxTitle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .boxTitle .t {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.4px;
      }
      .boxTitle .k {
        font-size: 12px;
        color: var(--ink);
        font-weight: 600;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .tool {
        border: 1px solid var(--stroke);
        background: #fff;
        border-radius: 16px;
        padding: 10px;
        cursor: grab;
        user-select: none;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .tool:active {
        cursor: grabbing;
        transform: translateY(1px);
      }
      .tool .ic {
        width: 36px;
        height: 36px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.04);
        border: 1px solid rgba(15, 23, 42, 0.1);
        display: grid;
        place-items: center;
        font-size: 18px;
      }
      .tool .name {
        font-size: 12px;
        font-weight: 700;
        line-height: 1.1;
      }
      .tool .meta {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
        line-height: 1.1;
      }

      .chemList {
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow: auto;
        max-height: 55vh;
        padding-right: 4px;
      }
      .chemList::-webkit-scrollbar {
        width: 8px;
      }
      .chemList::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 42, 0.14);
        border-radius: 999px;
      }

      .chemBtn {
        border: 1px solid var(--stroke);
        background: #fff;
        border-radius: 16px;
        padding: 10px 10px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: flex-start;
      }
      .chemBtn.is-armed {
        border-color: rgba(255, 45, 85, 0.38);
        box-shadow: 0 0 0 5px rgba(255, 45, 85, 0.1) inset;
      }
      .chemBtn .lefty {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .chemBtn .nm {
        font-size: 12px;
        font-weight: 800;
      }
      .chemBtn .fx {
        font-size: 11px;
        color: var(--muted);
      }
      .chemBtn .tag {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.92);
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 999px;
        padding: 4px 8px;
        white-space: nowrap;
      }

      /* Bench */
      .benchWrap {
        position: relative;
        min-height: 520px;
      }
      .bench {
        position: relative;
        min-height: 520px;
        border-radius: 22px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.82),
          rgba(255, 255, 255, 0.62)
        );
        border: 1px solid rgba(15, 23, 42, 0.1);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .bench::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(
            900px 300px at 50% 30%,
            rgba(255, 45, 85, 0.07),
            rgba(255, 255, 255, 0)
          ),
          radial-gradient(
            700px 260px at 70% 70%,
            rgba(59, 130, 246, 0.07),
            rgba(255, 255, 255, 0)
          );
        pointer-events: none;
      }
      .benchTopLabel {
        position: absolute;
        top: 12px;
        left: 12px;
        display: flex;
        gap: 10px;
        align-items: center;
        z-index: 2;
        flex-wrap: wrap;
      }
      .benchTopLabel .pill {
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.86);
        border-radius: 999px;
        padding: 8px 12px;
        box-shadow: 0 10px 18px rgba(2, 6, 23, 0.08);
        font-size: 12px;
        color: var(--muted);
        user-select: none;
      }
      .benchTopLabel .pill strong {
        color: var(--ink);
      }

      .dropzone {
        position: absolute;
        inset: 64px 16px 16px 16px;
        border-radius: 18px;
        border: 1px dashed rgba(15, 23, 42, 0.14);
        background: rgba(255, 255, 255, 0.35);
        z-index: 1;
      }

      /* Placed objects */
      .obj {
        position: absolute;
        width: 160px;
        height: 200px;
        transform: translate(-50%, -50%);
        user-select: none;
        touch-action: none;
        z-index: 5;
      }
      .obj.selected {
        outline: 2px solid rgba(255, 45, 85, 0.4);
        outline-offset: 6px;
        border-radius: 18px;
      }
      .obj .label {
        position: absolute;
        top: -34px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.82);
        color: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.12);
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 999px;
        white-space: nowrap;
        box-shadow: 0 14px 22px rgba(2, 6, 23, 0.12);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .obj .label .miniDot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(52, 211, 153, 0.9);
      }

      .glassSvg {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 22px 28px rgba(2, 6, 23, 0.12));
      }
      .glassStroke {
        stroke: rgba(15, 23, 42, 0.22);
        stroke-width: 2.2;
        fill: rgba(255, 255, 255, 0.62);
      }
      .rimStroke {
        stroke: rgba(15, 23, 42, 0.26);
        stroke-width: 3;
        stroke-linecap: round;
        fill: none;
      }
      .marks line {
        stroke: rgba(15, 23, 42, 0.18);
        stroke-width: 2;
      }
      .marks text {
        fill: rgba(15, 23, 42, 0.5);
        font-size: 12px;
        font-family: Poppins;
      }

      .liq {
        fill: rgba(39, 174, 96, 0.14);
      }
      .liqWave {
        fill: rgba(39, 174, 96, 0.22);
      }

      .fxLayer {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        border-radius: 18px;
      }

      .bubble {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(15, 23, 42, 0.1);
        opacity: 0.95;
        animation: rise 1200ms ease-in forwards;
        filter: blur(0.1px);
      }
      @keyframes rise {
        0% {
          transform: translateY(0) scale(0.8);
          opacity: 0.95;
        }
        80% {
          opacity: 0.7;
        }
        100% {
          transform: translateY(-120px) scale(1.2);
          opacity: 0;
        }
      }

      .precip {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 3px;
        opacity: 0.95;
        animation: sink 1400ms ease-in forwards;
        filter: drop-shadow(0 6px 10px rgba(2, 6, 23, 0.12));
      }
      @keyframes sink {
        0% {
          transform: translateY(-40px) rotate(0deg);
          opacity: 0.95;
        }
        100% {
          transform: translateY(110px) rotate(60deg);
          opacity: 0.7;
        }
      }

      /* Pour stream (click/apply animation) */
      .stream {
        position: absolute;
        width: 6px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.85),
          rgba(255, 255, 255, 0.35),
          rgba(255, 255, 255, 0)
        );
        opacity: 0;
        filter: drop-shadow(0 10px 18px rgba(2, 6, 23, 0.12));
        transform-origin: top center;
        pointer-events: none;
        z-index: 40;
      }
      .stream.show {
        opacity: 1;
        animation: streamFade 420ms ease-out forwards;
      }
      @keyframes streamFade {
        0% {
          opacity: 0;
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* Burner */
      .burner {
        width: 160px;
        height: 160px;
      }
      .burnerBase {
        position: absolute;
        left: 50%;
        top: 60%;
        transform: translate(-50%, -50%);
        width: 120px;
        height: 70px;
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.92);
        box-shadow: 0 22px 36px rgba(2, 6, 23, 0.22);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .burnerNeck {
        position: absolute;
        left: 50%;
        top: 34%;
        transform: translate(-50%, -50%);
        width: 46px;
        height: 50px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.88);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .flame {
        position: absolute;
        left: 50%;
        top: 18%;
        transform: translate(-50%, -50%);
        width: 46px;
        height: 66px;
        border-radius: 999px;
        background: radial-gradient(
          circle at 50% 65%,
          rgba(59, 130, 246, 0.85),
          rgba(255, 176, 0, 0.75),
          rgba(255, 45, 85, 0.4),
          rgba(0, 0, 0, 0)
        );
        opacity: 0;
        filter: blur(0.2px) drop-shadow(0 18px 18px rgba(255, 176, 0, 0.18));
        animation: flicker 260ms ease-in-out infinite alternate;
      }
      @keyframes flicker {
        from {
          transform: translate(-50%, -50%) scale(0.95) rotate(-2deg);
        }
        to {
          transform: translate(-50%, -50%) scale(1.05) rotate(2deg);
        }
      }
      .burner.on .flame {
        opacity: 1;
      }

      /* Right controls */
      .ctrls {
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 520px;
      }
      .controlRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .ctl {
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.72);
        border-radius: 18px;
        box-shadow: var(--shadow2);
        padding: 12px;
        min-height: 86px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        justify-content: space-between;
      }
      .ctl .ttl {
        font-size: 12px;
        color: var(--muted);
      }
      .ctl .val {
        font-size: 15px;
        font-weight: 800;
        color: var(--ink);
      }

      .stepper {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .stepper button {
        width: 38px;
        height: 38px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: #fff;
        cursor: pointer;
        user-select: none;
        font-size: 18px;
      }
      .stepper button:active {
        transform: translateY(1px);
      }

      .slider {
        height: 14px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(15, 23, 42, 0.12);
        overflow: hidden;
      }
      .slider .bar {
        height: 100%;
        width: 30%;
        background: linear-gradient(
          90deg,
          rgba(52, 211, 153, 0.75),
          rgba(59, 130, 246, 0.75)
        );
      }

      .bigBtn {
        height: 46px;
        border-radius: 16px;
        border: 1px solid var(--stroke);
        background: #fff;
        box-shadow: var(--shadow2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 800;
        user-select: none;
      }
      .bigBtn:active {
        transform: translateY(1px);
      }
      .bigBtn.primary {
        border-color: rgba(255, 45, 85, 0.3);
        box-shadow:
          0 0 0 5px rgba(255, 45, 85, 0.1) inset,
          var(--shadow2);
      }

      .log {
        flex: 1;
        min-height: 0;
        overflow: auto;
        padding-right: 4px;
        max-height: 46vh;
      }
      .log::-webkit-scrollbar {
        width: 8px;
      }
      .log::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 42, 0.14);
        border-radius: 999px;
      }
      .logItem {
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(15, 23, 42, 0.1);
        border-radius: 16px;
        padding: 10px 10px;
        box-shadow: 0 10px 18px rgba(2, 6, 23, 0.08);
        margin-bottom: 10px;
      }
      .logItem .t {
        font-size: 12px;
        font-weight: 800;
      }
      .logItem .d {
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
        line-height: 1.35;
      }

      /* Toast */
      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.86);
        color: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 12px;
        box-shadow: 0 18px 40px rgba(2, 6, 23, 0.18);
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.18s ease,
          transform 0.18s ease;
        z-index: 80;
        max-width: min(860px, calc(100% - 40px));
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-6px);
      }

      /* Responsive */
      @media (max-width: 1150px) {
        .layout {
          grid-template-columns: 260px 1fr 260px;
        }
      }
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .side {
          min-width: auto;
        }
        .benchWrap {
          min-height: 520px;
        }
        .chemList {
          max-height: 34vh;
        }
        .log {
          max-height: 30vh;
        }
        .panelToggle {
          top: 120px;
        }
      }
    </style>
  </head>

  <body>
    <main class="vlab" id="vlab">
      <div class="top">
        <div class="brand">
          <div class="dot"></div>
          <div>
            <div class="h1">Virtual Chemistry Lab</div>
            <div class="sub">
              Drag apparatus â€¢ Add reagents â€¢ Real equations â€¢ Sounds & effects
              â€¢ Scroll supported
            </div>
          </div>
        </div>

        <div class="actions">
          <div
            class="chip"
            title="Select a chemical then apply into a selected container"
          >
            Armed: <strong id="armedName">None</strong>
          </div>
          <button class="btn" id="btnSound" title="Toggle sound">
            ðŸ”Š Sound: <strong id="soundState">ON</strong>
          </button>
          <button class="btn" id="btnReset" title="Reset everything">
            âŸ² Reset
          </button>
        </div>
      </div>

      <!-- âœ… Collapsible â€œblack container as a buttonâ€ -->
      <div class="panelToggle">
        <button class="ptBtn" id="panelBtn" type="button" aria-expanded="true">
          <span class="ptDot"></span>
          <span class="ptText"
            ><strong>Lab Panel</strong> (Contents & Reactions)</span
          >
          <span class="ptHint" id="panelHint">Click to collapse â–²</span>
        </button>
      </div>

      <!-- Panel (collapsible) -->
      <section class="panel" id="panel" aria-label="Contents and reactions">
        <div class="tabs">
          <div class="tabsLeft">
            <button class="tab is-active" data-tab="contents">CONTENTS</button>
            <button class="tab" data-tab="reactions">REACTIONS</button>
          </div>

          <div class="miniStats">
            <span class="badge" title="Selected container">
              <span class="dotSm" id="selDot"></span>
              Vessel: <strong id="selVessel">None</strong>
            </span>
            <span class="badge" title="Temperature (selected vessel)">
              <span class="dotSm hot" id="tempDot"></span>
              Temp: <strong id="selTemp">â€”</strong>
            </span>
            <span class="badge" title="Safety status (selected vessel)">
              <span
                class="dotSm warn"
                id="warnDot"
                style="opacity: 0.35"
              ></span>
              Safety: <strong id="warnText">OK</strong>
            </span>
          </div>
        </div>

        <div class="panelBody" id="tab_contents">
          <div class="thead">
            <span>Species</span>
            <span class="right">Moles</span>
            <span class="right">State</span>
            <span class="right">Notes</span>
          </div>
          <div class="rows" id="contentsRows"></div>
          <div class="hint" id="contentsHint">
            1) Drag a beaker/flask/test tube onto the bench<br />
            2) Click the vessel to select it<br />
            3) Click a chemical to arm it, then press <b>Apply</b> (right side)
            OR click the vessel to pour<br />
            Tip: Drag the <b>Bunsen burner</b> under the vessel, then
            <b>Ignite</b>.
          </div>
        </div>

        <div class="panelBody is-hidden" id="tab_reactions">
          <div class="hint">
            This demo uses real chemical equations and basic stoichiometry
            (limiting reagent). It simulates: neutralization (heat), gas
            evolution (COâ‚‚ fizz), and precipitation (AgCl, Cu(OH)â‚‚, CaCOâ‚ƒ).
          </div>
          <div class="rxnList" id="rxnList"></div>
        </div>
      </section>

      <section class="layout">
        <!-- Left -->
        <aside class="side">
          <div class="box">
            <div class="boxTitle">
              <div class="t">APPARATUS</div>
              <div class="k">Drag to bench</div>
            </div>
            <div class="grid" id="toolGrid"></div>
          </div>

          <div class="box">
            <div class="boxTitle">
              <div class="t">CHEMICALS</div>
              <div class="k">Tap to arm</div>
            </div>
            <div class="chemList" id="chemList"></div>
          </div>
        </aside>

        <!-- Center bench -->
        <section class="benchWrap">
          <div class="bench" id="bench">
            <div class="benchTopLabel">
              <div class="pill">
                Click vessel â†’ select â€¢ Drag objects â€¢ Click vessel again â†’ pour
              </div>
              <div class="pill">Realistic FX: bubbles/precipitate + sounds</div>
            </div>
            <div class="dropzone" id="dropzone"></div>
            <div class="stream" id="stream"></div>
          </div>
        </section>

        <!-- Right -->
        <aside class="ctrls">
          <div class="controlRow">
            <div class="ctl">
              <div class="ttl">Dose / Add amount</div>
              <div class="val"><span id="doseVal">1.00</span>Ã—</div>
              <div class="stepper">
                <button id="doseMinus">âˆ’</button>
                <button id="dosePlus">+</button>
              </div>
            </div>

            <div class="ctl">
              <div class="ttl">pH (selected vessel)</div>
              <div class="val" id="phVal">â€”</div>
              <div class="slider" title="pH indicator">
                <div class="bar" id="phBar"></div>
              </div>
            </div>
          </div>

          <div class="controlRow">
            <div class="ctl">
              <div class="ttl">Stir</div>
              <div class="val">Mix contents</div>
              <button class="bigBtn" id="btnStir">ðŸŒ€ Stir vessel</button>
            </div>

            <div class="ctl">
              <div class="ttl">Heat</div>
              <div class="val">Bunsen burner</div>
              <button class="bigBtn" id="btnIgnite">ðŸ”¥ Ignite/Off</button>
            </div>
          </div>

          <div class="ctl" style="min-height: 120px">
            <div class="ttl">Apply armed chemical â†’ selected vessel</div>
            <div class="val" id="applyInfo">Select a vessel</div>
            <button class="bigBtn primary" id="btnApply">ðŸ§ª Apply</button>
          </div>

          <div class="box" style="flex: 1">
            <div class="boxTitle">
              <div class="t">LAB LOG</div>
              <div class="k">Actions</div>
            </div>
            <div class="log" id="log"></div>
          </div>
        </aside>
      </section>

      <div class="toast" id="toast">â€”</div>
    </main>

    <script>
      (() => {
        const $ = (id) => document.getElementById(id);
        const bench = $("bench");
        const toolGrid = $("toolGrid");
        const chemList = $("chemList");
        const armedName = $("armedName");
        const soundState = $("soundState");
        const btnSound = $("btnSound");

        const panel = $("panel");
        const panelBtn = $("panelBtn");
        const panelHint = $("panelHint");

        const tabs = document.querySelectorAll(".tab");
        const tabContents = $("tab_contents");
        const tabReactions = $("tab_reactions");

        const contentsRows = $("contentsRows");
        const contentsHint = $("contentsHint");
        const rxnList = $("rxnList");

        const selVesselLabel = $("selVessel");
        const selTempLabel = $("selTemp");
        const selDot = $("selDot");
        const tempDot = $("tempDot");

        const warnDot = $("warnDot");
        const warnText = $("warnText");

        const doseVal = $("doseVal");
        const phVal = $("phVal");
        const phBar = $("phBar");

        const btnApply = $("btnApply");
        const applyInfo = $("applyInfo");
        const btnStir = $("btnStir");
        const btnIgnite = $("btnIgnite");
        const btnReset = $("btnReset");
        const toastEl = $("toast");
        const logEl = $("log");

        const dosePlus = $("dosePlus");
        const doseMinus = $("doseMinus");

        const stream = $("stream");

        function clamp(n, a, b) {
          return Math.max(a, Math.min(b, n));
        }

        // âœ… Collapsible panel behavior
        let panelOpen = true;
        function setPanelOpen(open) {
          panelOpen = !!open;
          panel.classList.toggle("is-collapsed", !panelOpen);
          panelBtn.setAttribute("aria-expanded", String(panelOpen));
          panelHint.textContent = panelOpen
            ? "Click to collapse â–²"
            : "Click to open â–¼";
        }
        panelBtn.addEventListener("click", () => {
          setPanelOpen(!panelOpen);
          SFX.click();
        });

        // -------------------------
        // Sound Engine (WebAudio)
        // -------------------------
        let audioOn = true;
        let audioCtx = null;

        function ensureAudio() {
          if (!audioOn) return null;
          if (!audioCtx)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          if (audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
          return audioCtx;
        }

        function beep({
          freq = 440,
          dur = 0.08,
          type = "sine",
          gain = 0.04,
        } = {}) {
          const ctx = ensureAudio();
          if (!ctx) return;
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = type;
          o.frequency.value = freq;
          g.gain.value = 0.0001;
          o.connect(g);
          g.connect(ctx.destination);
          const t = ctx.currentTime;
          g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
          o.start(t);
          o.stop(t + dur + 0.02);
        }

        function noise({ dur = 0.18, gain = 0.05, tone = 1200 } = {}) {
          const ctx = ensureAudio();
          if (!ctx) return;
          const bufferSize = ctx.sampleRate * dur;
          const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
          const data = buffer.getChannelData(0);
          for (let i = 0; i < data.length; i++)
            data[i] = (Math.random() * 2 - 1) * (1 - i / data.length);
          const src = ctx.createBufferSource();
          src.buffer = buffer;

          const biq = ctx.createBiquadFilter();
          biq.type = "lowpass";
          biq.frequency.value = tone;

          const g = ctx.createGain();
          g.gain.value = gain;

          src.connect(biq);
          biq.connect(g);
          g.connect(ctx.destination);
          const t = ctx.currentTime;
          src.start(t);
          src.stop(t + dur);
        }

        const SFX = {
          click() {
            beep({ freq: 760, dur: 0.05, type: "triangle", gain: 0.03 });
          },
          place() {
            beep({ freq: 520, dur: 0.06, type: "sine", gain: 0.04 });
            noise({ dur: 0.08, gain: 0.02, tone: 1800 });
          },
          pour() {
            noise({ dur: 0.25, gain: 0.035, tone: 900 });
          },
          clink() {
            beep({ freq: 1200, dur: 0.05, type: "sine", gain: 0.025 });
            beep({ freq: 900, dur: 0.07, type: "triangle", gain: 0.02 });
          },
          fizz() {
            noise({ dur: 0.55, gain: 0.05, tone: 1400 });
          },
          precip() {
            noise({ dur: 0.18, gain: 0.03, tone: 800 });
          },
          flameOn() {
            noise({ dur: 0.25, gain: 0.045, tone: 600 });
            beep({ freq: 180, dur: 0.08, type: "sawtooth", gain: 0.02 });
          },
          flameOff() {
            beep({ freq: 220, dur: 0.08, type: "sine", gain: 0.02 });
          },
          stir() {
            noise({ dur: 0.3, gain: 0.03, tone: 1100 });
          },
          error() {
            beep({ freq: 220, dur: 0.14, type: "square", gain: 0.02 });
          },
        };

        btnSound.addEventListener("click", () => {
          audioOn = !audioOn;
          soundState.textContent = audioOn ? "ON" : "OFF";
          SFX.click();
          toast(audioOn ? "Sound ON" : "Sound OFF");
        });

        // -------------------------
        // Chemistry Model (real equations + basic stoichiometry)
        // -------------------------
        const CHEM = [
          {
            id: "H2O",
            name: "Water",
            formula: "Hâ‚‚O",
            kind: "solvent",
            color: { r: 39, g: 174, b: 96, a: 0.1 },
            addMol: 5.67,
            note: "Solvent",
            tag: "solvent",
          },

          {
            id: "HCl",
            name: "Hydrochloric acid (aq)",
            formula: "HCl",
            kind: "acidStrong",
            addMol: 0.05,
            note: "Strong acid",
            tag: "acid",
          },
          {
            id: "H2SO4",
            name: "Sulfuric acid (aq)",
            formula: "Hâ‚‚SOâ‚„",
            kind: "acidStrong2",
            addMol: 0.03,
            note: "Diprotic (demo)",
            tag: "acid",
          },

          {
            id: "NaOH",
            name: "Sodium hydroxide (aq)",
            formula: "NaOH",
            kind: "baseStrong",
            addMol: 0.05,
            note: "Strong base",
            tag: "base",
          },

          {
            id: "NaCl",
            name: "Sodium chloride (aq)",
            formula: "NaCl",
            kind: "salt",
            addMol: 0.04,
            note: "Source of Clâ»",
            tag: "salt",
          },
          {
            id: "AgNO3",
            name: "Silver nitrate (aq)",
            formula: "AgNOâ‚ƒ",
            kind: "salt",
            addMol: 0.02,
            note: "Source of Agâº",
            tag: "salt",
          },
          {
            id: "CuSO4",
            name: "Copper(II) sulfate (aq)",
            formula: "CuSOâ‚„",
            kind: "salt",
            addMol: 0.02,
            note: "Source of CuÂ²âº (blue)",
            tag: "salt",
          },
          {
            id: "CaCl2",
            name: "Calcium chloride (aq)",
            formula: "CaClâ‚‚",
            kind: "salt",
            addMol: 0.02,
            note: "Source of CaÂ²âº",
            tag: "salt",
          },
          {
            id: "Na2CO3",
            name: "Sodium carbonate (aq)",
            formula: "Naâ‚‚COâ‚ƒ",
            kind: "salt",
            addMol: 0.02,
            note: "Source of COâ‚ƒÂ²â»",
            tag: "salt",
          },

          {
            id: "NaHCO3",
            name: "Sodium bicarbonate",
            formula: "NaHCOâ‚ƒ",
            kind: "bicarb",
            addMol: 0.03,
            note: "Acid â†’ COâ‚‚",
            tag: "carbonate",
          },

          {
            id: "Phen",
            name: "Phenolphthalein (indicator)",
            formula: "PhPh",
            kind: "indicator",
            addMol: 0.0002,
            note: "Pink in base",
            tag: "indicator",
          },
        ];

        function ionicContrib(reagentId, mol) {
          const aq = {};
          let tint = null;
          switch (reagentId) {
            case "HCl":
              aq["H+"] = (aq["H+"] || 0) + mol;
              aq["Cl-"] = (aq["Cl-"] || 0) + mol;
              break;
            case "H2SO4":
              // demo: 2 H+ per mole
              aq["H+"] = (aq["H+"] || 0) + 2 * mol;
              aq["SO4--"] = (aq["SO4--"] || 0) + mol;
              break;
            case "NaOH":
              aq["Na+"] = (aq["Na+"] || 0) + mol;
              aq["OH-"] = (aq["OH-"] || 0) + mol;
              break;
            case "NaCl":
              aq["Na+"] = (aq["Na+"] || 0) + mol;
              aq["Cl-"] = (aq["Cl-"] || 0) + mol;
              break;
            case "AgNO3":
              aq["Ag+"] = (aq["Ag+"] || 0) + mol;
              aq["NO3-"] = (aq["NO3-"] || 0) + mol;
              break;
            case "CuSO4":
              aq["Cu++"] = (aq["Cu++"] || 0) + mol;
              aq["SO4--"] = (aq["SO4--"] || 0) + mol;
              tint = { r: 59, g: 130, b: 246, a: 0.14 };
              break;
            case "CaCl2":
              aq["Ca++"] = (aq["Ca++"] || 0) + mol;
              aq["Cl-"] = (aq["Cl-"] || 0) + 2 * mol;
              break;
            case "Na2CO3":
              aq["Na+"] = (aq["Na+"] || 0) + 2 * mol;
              aq["CO3--"] = (aq["CO3--"] || 0) + mol;
              break;
            case "NaHCO3":
              aq["Na+"] = (aq["Na+"] || 0) + mol;
              aq["HCO3-"] = (aq["HCO3-"] || 0) + mol;
              break;
            case "Phen":
              aq["Phen"] = (aq["Phen"] || 0) + mol;
              break;
          }
          return { aq, tint };
        }

        function fmtMol(x) {
          if (!Number.isFinite(x)) return "0";
          if (x >= 1) return x.toFixed(3);
          if (x >= 0.01) return x.toFixed(4);
          return x.toExponential(2);
        }

        function addToMap(map, key, val) {
          if (!val || !Number.isFinite(val)) return;
          map[key] = (map[key] || 0) + val;
          if (map[key] < 1e-12) delete map[key];
        }

        function computePH(v) {
          const H = v.aq["H+"] || 0;
          const OH = v.aq["OH-"] || 0;
          const vol = Math.max(v.volumeL, 0.02);

          if (H > OH) {
            const conc = Math.max((H - OH) / vol, 1e-14);
            const pH = -Math.log10(conc);
            return clamp(pH, 0, 14);
          } else if (OH > H) {
            const conc = Math.max((OH - H) / vol, 1e-14);
            const pOH = -Math.log10(conc);
            const pH = 14 - pOH;
            return clamp(pH, 0, 14);
          }
          return 7.0;
        }

        function mixTint(a, b, t) {
          return {
            r: Math.round(a.r + (b.r - a.r) * t),
            g: Math.round(a.g + (b.g - a.g) * t),
            b: Math.round(a.b + (b.b - a.b) * t),
            a: Math.max(0.08, Math.min(0.28, a.a + (b.a - a.a) * t)),
          };
        }

        // -------------------------
        // Lab State
        // -------------------------
        const state = {
          dose: 1.0,
          armed: null,
          selectedId: null,
          objects: new Map(),
        };

        // Apparatus
        const TOOLS = [
          { type: "beaker", name: "Beaker", meta: "250 mL", ic: "ðŸ§ª" },
          { type: "flask", name: "Erlenmeyer", meta: "250 mL", ic: "âš—ï¸" },
          { type: "testtube", name: "Test Tube", meta: "50 mL", ic: "ðŸ§«" },
          {
            type: "cylinder",
            name: "Measuring Cylinder",
            meta: "100 mL",
            ic: "ðŸ§´",
          },
          {
            type: "burner",
            name: "Bunsen Burner",
            meta: "Heat source",
            ic: "ðŸ”¥",
          },
        ];

        // -------------------------
        // UI Helpers
        // -------------------------
        let toastTimer = null;
        function toast(msg) {
          toastEl.textContent = msg;
          toastEl.classList.add("show");
          clearTimeout(toastTimer);
          toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1400);
        }

        function log(title, desc) {
          const wrap = document.createElement("div");
          wrap.className = "logItem";
          wrap.innerHTML = `<div class="t">${escapeHtml(title)}</div><div class="d">${escapeHtml(desc)}</div>`;
          logEl.prepend(wrap);
        }

        function escapeHtml(s) {
          return String(s || "").replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#039;",
              })[m],
          );
        }

        function setArmed(item) {
          state.armed = item;
          armedName.textContent = item ? item.formula : "None";
          document
            .querySelectorAll(".chemBtn")
            .forEach((b) => b.classList.remove("is-armed"));
          if (item) {
            const btn = document.querySelector(
              `.chemBtn[data-id="${CSS.escape(item.id)}"]`,
            );
            if (btn) btn.classList.add("is-armed");
            toast(`Armed: ${item.name}`);
            SFX.click();
          } else {
            toast("Armed: None");
          }
          refreshApplyInfo();
        }

        function setSelected(id) {
          state.selectedId = id;
          document
            .querySelectorAll(".obj")
            .forEach((o) => o.classList.remove("selected"));
          const obj = state.objects.get(id);
          if (obj && obj.el) {
            obj.el.classList.add("selected");
            selVesselLabel.textContent = obj.label;
            updateHUD(obj);
            SFX.clink();
          } else {
            selVesselLabel.textContent = "None";
            selTempLabel.textContent = "â€”";
            phVal.textContent = "â€”";
            phBar.style.width = "0%";
            selDot.style.background = "rgba(255,255,255,.35)";
            warnDot.style.opacity = ".35";
            warnText.textContent = "OK";
          }
          refreshApplyInfo();
          renderPanelContents();
          renderReactionsList();
        }

        function refreshApplyInfo() {
          const obj = state.objects.get(state.selectedId);
          if (!obj || !obj.isVessel) {
            applyInfo.textContent = "Select a vessel";
            btnApply.disabled = true;
            btnApply.style.opacity = ".6";
            return;
          }
          btnApply.disabled = false;
          btnApply.style.opacity = "1";
          if (!state.armed) {
            applyInfo.textContent = `Selected: ${obj.label} â€” arm a chemical`;
          } else {
            applyInfo.textContent = `Apply ${state.armed.formula} into ${obj.label}`;
          }
        }

        // -------------------------
        // Bench objects
        // -------------------------
        let idSeq = 1;
        function uid(prefix) {
          return `${prefix}_${idSeq++}`;
        }

        function createToolCard(tool) {
          const el = document.createElement("div");
          el.className = "tool";
          el.innerHTML = `
          <div class="ic">${tool.ic}</div>
          <div>
            <div class="name">${tool.name}</div>
            <div class="meta">${tool.meta}</div>
          </div>
        `;
          el.addEventListener("pointerdown", (e) => {
            e.preventDefault();
            SFX.click();
            startPlace(tool, e);
          });
          return el;
        }

        function startPlace(tool, e) {
          const rect = bench.getBoundingClientRect();
          const ghost = document.createElement("div");
          ghost.className = "tool";
          ghost.style.position = "fixed";
          ghost.style.zIndex = "1000";
          ghost.style.width = "220px";
          ghost.style.opacity = "0.85";
          ghost.style.pointerEvents = "none";
          ghost.innerHTML = `
          <div class="ic">${tool.ic}</div>
          <div>
            <div class="name">${tool.name}</div>
            <div class="meta">Drop on bench</div>
          </div>
        `;
          document.body.appendChild(ghost);

          const move = (ev) => {
            ghost.style.left = ev.clientX - 110 + "px";
            ghost.style.top = ev.clientY - 22 + "px";
          };
          move(e);

          const up = (ev) => {
            window.removeEventListener("pointermove", move);
            window.removeEventListener("pointerup", up);
            ghost.remove();

            const bx = ev.clientX,
              by = ev.clientY;
            const inside =
              bx >= rect.left &&
              bx <= rect.right &&
              by >= rect.top &&
              by <= rect.bottom;

            if (!inside) {
              SFX.error();
              toast("Drop onto the bench area");
              return;
            }

            const x = bx - rect.left;
            const y = by - rect.top;

            placeObject(tool.type, x, y);
          };

          window.addEventListener("pointermove", move);
          window.addEventListener("pointerup", up, { once: true });
        }

        function placeObject(type, x, y) {
          const id = uid(type);
          const obj = buildObject(type, id, x, y);
          state.objects.set(id, obj);
          bench.appendChild(obj.el);
          SFX.place();
          toast(`${obj.label} placed`);
          log("Placed", `${obj.label} on bench`);
          if (obj.isVessel) setSelected(id);
          renderPanelContents();
          renderReactionsList();
        }

        function makeVesselState(type) {
          return {
            volumeL:
              type === "testtube" ? 0.05 : type === "cylinder" ? 0.1 : 0.25,
            tempC: 25,
            aq: {},
            solids: {},
            gas: {},
            hasPhen: false,
            tint: { r: 39, g: 174, b: 96, a: 0.1 },
            level: 0.18,
            reactions: [], // each: {title, eq, note, tag, lr, extent}
          };
        }

        function vesselHTML(obj) {
          if (obj.type === "beaker") {
            return `
            <div class="label"><span class="miniDot"></span> Beaker</div>
            <div class="fxLayer"></div>
            <svg class="glassSvg" viewBox="0 0 300 320" aria-hidden="true">
              <path d="M78 40h144v210c0 26-20 46-46 46H124c-26 0-46-20-46-46V40Z" class="glassStroke"/>
              <path d="M74 40h152" class="rimStroke"/>
              <path d="M222 40c10 0 18 8 18 18" class="rimStroke"/>
              <g class="marks">
                <line x1="185" y1="85" x2="230" y2="85"/>
                <line x1="185" y1="120" x2="220" y2="120"/>
                <line x1="185" y1="155" x2="230" y2="155"/>
                <line x1="185" y1="190" x2="220" y2="190"/>
                <text x="232" y="88">250</text>
                <text x="222" y="158">150</text>
              </g>
              <clipPath id="clip_${obj.id}">
                <path d="M78 40h144v210c0 26-20 46-46 46H124c-26 0-46-20-46-46V40Z"/>
              </clipPath>
              <g clip-path="url(#clip_${obj.id})">
                <rect x="78" y="40" width="144" height="260" class="liq" data-liqrect />
                <path d="M78 210c20 10 40 10 72 0s52-10 72 0v80H78v-80Z" class="liqWave" data-liqwave />
              </g>
            </svg>
          `;
          }
          if (obj.type === "flask") {
            return `
            <div class="label"><span class="miniDot"></span> Flask</div>
            <div class="fxLayer"></div>
            <svg class="glassSvg" viewBox="0 0 300 320" aria-hidden="true">
              <path d="M140 30h20v70c0 10 8 20 16 28l44 48c10 10 16 24 16 38v10c0 34-28 62-62 62h-68c-34 0-62-28-62-62v-10c0-14 6-28 16-38l44-48c8-8 16-18 16-28V30Z"
                class="glassStroke"/>
              <path d="M135 30h30" class="rimStroke"/>
              <clipPath id="clip_${obj.id}">
                <path d="M140 30h20v70c0 10 8 20 16 28l44 48c10 10 16 24 16 38v10c0 34-28 62-62 62h-68c-34 0-62-28-62-62v-10c0-14 6-28 16-38l44-48c8-8 16-18 16-28V30Z"/>
              </clipPath>
              <g clip-path="url(#clip_${obj.id})">
                <rect x="64" y="90" width="172" height="220" class="liq" data-liqrect />
                <path d="M64 210c26 12 54 12 86 0s60-12 86 0v120H64v-120Z" class="liqWave" data-liqwave />
              </g>
            </svg>
          `;
          }
          if (obj.type === "cylinder") {
            return `
            <div class="label"><span class="miniDot"></span> Cylinder</div>
            <div class="fxLayer"></div>
            <svg class="glassSvg" viewBox="0 0 240 320" aria-hidden="true">
              <path d="M90 30h60v240c0 18-14 30-30 30s-30-12-30-30V30Z" class="glassStroke"/>
              <path d="M86 30h68" class="rimStroke"/>
              <g class="marks">
                <line x1="150" y1="70" x2="190" y2="70"/><text x="192" y="74">100</text>
                <line x1="150" y1="120" x2="180" y2="120"/><text x="182" y="124">70</text>
                <line x1="150" y1="170" x2="190" y2="170"/><text x="192" y="174">40</text>
                <line x1="150" y1="220" x2="180" y2="220"/><text x="182" y="224">10</text>
              </g>
              <clipPath id="clip_${obj.id}">
                <path d="M90 30h60v240c0 18-14 30-30 30s-30-12-30-30V30Z"/>
              </clipPath>
              <g clip-path="url(#clip_${obj.id})">
                <rect x="90" y="30" width="60" height="280" class="liq" data-liqrect />
                <path d="M90 190c10 8 24 8 30 0s20-8 30 0v120H90v-120Z" class="liqWave" data-liqwave />
              </g>
            </svg>
          `;
          }
          return `
          <div class="label"><span class="miniDot"></span> Test Tube</div>
          <div class="fxLayer"></div>
          <svg class="glassSvg" viewBox="0 0 240 320" aria-hidden="true">
            <path d="M85 30h70v200c0 30-22 60-35 60s-35-30-35-60V30Z" class="glassStroke"/>
            <path d="M80 30h80" class="rimStroke"/>
            <clipPath id="clip_${obj.id}">
              <path d="M85 30h70v200c0 30-22 60-35 60s-35-30-35-60V30Z"/>
            </clipPath>
            <g clip-path="url(#clip_${obj.id})">
              <rect x="85" y="30" width="70" height="260" class="liq" data-liqrect />
              <path d="M85 190c10 8 24 8 35 0s25-8 35 0v120H85v-120Z" class="liqWave" data-liqwave />
            </g>
          </svg>
        `;
        }

        function attachVesselRefs(obj) {
          obj.fx = obj.el.querySelector(".fxLayer");
          obj.liqRect = obj.el.querySelector("[data-liqrect]");
          obj.liqWave = obj.el.querySelector("[data-liqwave]");
        }

        function updateVesselVisual(obj) {
          const v = obj.vessel;

          let topY = 40,
            fullH = 260,
            baseY = 40;
          if (obj.type === "flask") {
            topY = 90;
            fullH = 200;
            baseY = 90;
          }
          if (obj.type === "testtube") {
            topY = 30;
            fullH = 260;
            baseY = 30;
          }
          if (obj.type === "cylinder") {
            topY = 30;
            fullH = 280;
            baseY = 30;
          }

          const level = clamp(v.level, 0.08, 0.92);
          const y = topY + (1 - level) * fullH;
          const h = baseY + fullH - y;

          obj.liqRect.setAttribute("y", String(y));
          obj.liqRect.setAttribute("height", String(h));

          const waveBase = 210;
          obj.liqWave.setAttribute(
            "transform",
            `translate(0, ${y + 20 - waveBase})`,
          );

          const ph = computePH(v);

          // indicator (phenolphthalein): pink in base
          if (v.hasPhen && ph > 8.2) {
            obj.liqRect.style.fill = `rgba(255,45,85,0.14)`;
            obj.liqWave.style.fill = `rgba(255,45,85,0.22)`;
          } else {
            const { r, g, b, a } = v.tint;
            obj.liqRect.style.fill = `rgba(${r},${g},${b},${a})`;
            obj.liqWave.style.fill = `rgba(${r},${g},${b},${Math.min(a + 0.1, 0.35)})`;
          }
        }

        function buildObject(type, id, x, y) {
          const el = document.createElement("div");
          el.className = "obj";
          el.style.left = x + "px";
          el.style.top = y + "px";
          el.dataset.id = id;

          const obj = {
            id,
            type,
            el,
            x,
            y,
            isVessel: ["beaker", "flask", "testtube", "cylinder"].includes(
              type,
            ),
            label:
              type === "beaker"
                ? "Beaker"
                : type === "flask"
                  ? "Flask"
                  : type === "testtube"
                    ? "Test Tube"
                    : type === "cylinder"
                      ? "Cylinder"
                      : type === "burner"
                        ? "Bunsen Burner"
                        : "Apparatus",
            vessel: null,
            burnerOn: false,
          };

          if (obj.isVessel) {
            obj.vessel = makeVesselState(type);
            el.innerHTML = vesselHTML(obj);
            attachVesselRefs(obj);
            updateVesselVisual(obj);
          } else if (type === "burner") {
            el.classList.add("burner");
            el.innerHTML = `
            <div class="label"><span class="miniDot"></span> Burner</div>
            <div class="burnerBase"></div>
            <div class="burnerNeck"></div>
            <div class="flame"></div>
          `;
          }

          wireDrag(obj);

          el.addEventListener("click", (e) => {
            e.stopPropagation();
            if (obj.isVessel) {
              setSelected(obj.id);
              if (state.armed) {
                applyArmedToSelected({ via: "click" });
              }
            } else if (obj.type === "burner") {
              toggleBurner(obj);
            }
          });

          return obj;
        }

        function wireDrag(obj) {
          const el = obj.el;
          let dragging = false,
            startX = 0,
            startY = 0,
            baseX = 0,
            baseY = 0;

          el.addEventListener("pointerdown", (e) => {
            dragging = true;
            startX = e.clientX;
            startY = e.clientY;
            baseX = parseFloat(el.style.left) || 0;
            baseY = parseFloat(el.style.top) || 0;
            el.setPointerCapture(e.pointerId);
            el.style.cursor = "grabbing";
            e.preventDefault();
          });

          el.addEventListener("pointermove", (e) => {
            if (!dragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            const rect = bench.getBoundingClientRect();
            const nx = clamp(baseX + dx, 40, rect.width - 40);
            const ny = clamp(baseY + dy, 90, rect.height - 40);
            el.style.left = nx + "px";
            el.style.top = ny + "px";
            obj.x = nx;
            obj.y = ny;
          });

          el.addEventListener("pointerup", (e) => {
            if (!dragging) return;
            dragging = false;
            el.releasePointerCapture(e.pointerId);
            el.style.cursor = "grab";
            SFX.place();
          });
        }

        bench.addEventListener("click", () => setSelected(null));

        // -------------------------
        // Reactions engine (real equations + limiting reagent)
        // -------------------------
        function recordReaction(v, r) {
          v.reactions.unshift(r);
          v.reactions = v.reactions.slice(0, 8);
        }

        function runReactions(v, obj) {
          let changed = false;
          for (let pass = 0; pass < 4; pass++) {
            const did = applyReactionSet(v, obj);
            if (!did) break;
            changed = true;
          }
          return changed;
        }

        // helper: limiting reagent for aA + bB -> products (extent = min(A/a, B/b))
        function extent2(v, A, a, B, b) {
          const mA = v.aq[A] || 0;
          const mB = v.aq[B] || 0;
          const e = Math.min(mA / a, mB / b);
          const lr = mA / a < mB / b ? A : B;
          return { extent: Math.max(0, e), lr, mA, mB };
        }

        function applyReactionSet(v, obj) {
          let did = false;

          // 1) Neutralization: H+ + OH- -> H2O
          if ((v.aq["H+"] || 0) > 0 && (v.aq["OH-"] || 0) > 0) {
            const { extent, lr } = extent2(v, "H+", 1, "OH-", 1);
            if (extent > 0) {
              v.aq["H+"] -= extent;
              v.aq["OH-"] -= extent;
              v.tempC = clamp(v.tempC + extent * 120, 0, 100); // exothermic approx
              recordReaction(v, {
                title: "Neutralization",
                tag: "HEAT",
                eq: "Hâº(aq) + OHâ»(aq) â†’ Hâ‚‚O(l)",
                note: "Strong acid/base neutralization releases heat.",
                lr,
                extent,
              });
              SFX.fizz();
              spawnBubbles(obj, 14);
              did = true;
            }
          }

          // 2) Acid + bicarbonate: H+ + HCO3- -> CO2 + H2O
          if ((v.aq["H+"] || 0) > 0 && (v.aq["HCO3-"] || 0) > 0) {
            const { extent, lr } = extent2(v, "H+", 1, "HCO3-", 1);
            if (extent > 0) {
              v.aq["H+"] -= extent;
              v.aq["HCO3-"] -= extent;
              addToMap(v.gas, "COâ‚‚(g)", extent);
              recordReaction(v, {
                title: "Gas Evolution (COâ‚‚)",
                tag: "GAS",
                eq: "HCl(aq) + NaHCOâ‚ƒ(aq) â†’ NaCl(aq) + Hâ‚‚O(l) + COâ‚‚(g)",
                note: "Fizzing from COâ‚‚ bubbles.",
                lr,
                extent,
              });
              SFX.fizz();
              spawnBubbles(obj, 28);
              did = true;
            }
          }

          // 3) Ag+ + Cl- -> AgCl(s)
          if ((v.aq["Ag+"] || 0) > 0 && (v.aq["Cl-"] || 0) > 0) {
            const { extent, lr } = extent2(v, "Ag+", 1, "Cl-", 1);
            if (extent > 0) {
              v.aq["Ag+"] -= extent;
              v.aq["Cl-"] -= extent;
              addToMap(v.solids, "AgCl(s)", extent);
              recordReaction(v, {
                title: "Precipitation (AgCl)",
                tag: "PPT",
                eq: "AgNOâ‚ƒ(aq) + NaCl(aq) â†’ AgCl(s) + NaNOâ‚ƒ(aq)",
                note: "White precipitate forms.",
                lr,
                extent,
              });
              SFX.precip();
              spawnPrecip(obj, 18, "white");
              did = true;
            }
          }

          // 4) Cu2+ + 2OH- -> Cu(OH)2(s)
          if ((v.aq["Cu++"] || 0) > 0 && (v.aq["OH-"] || 0) > 0) {
            const mCu = v.aq["Cu++"] || 0;
            const mOH = v.aq["OH-"] || 0;
            const extent = Math.min(mCu / 1, mOH / 2);
            const lr = mCu / 1 < mOH / 2 ? "Cu++" : "OH-";
            if (extent > 0) {
              v.aq["Cu++"] -= extent;
              v.aq["OH-"] -= 2 * extent;
              addToMap(v.solids, "Cu(OH)â‚‚(s)", extent);
              recordReaction(v, {
                title: "Precipitation (Cu(OH)â‚‚)",
                tag: "PPT",
                eq: "CuSOâ‚„(aq) + 2 NaOH(aq) â†’ Cu(OH)â‚‚(s) + Naâ‚‚SOâ‚„(aq)",
                note: "Blue gelatinous precipitate forms.",
                lr,
                extent,
              });
              SFX.precip();
              spawnPrecip(obj, 22, "blue");
              did = true;
            }
          }

          // 5) Ca2+ + CO3-- -> CaCO3(s)
          if ((v.aq["Ca++"] || 0) > 0 && (v.aq["CO3--"] || 0) > 0) {
            const { extent, lr } = extent2(v, "Ca++", 1, "CO3--", 1);
            if (extent > 0) {
              v.aq["Ca++"] -= extent;
              v.aq["CO3--"] -= extent;
              addToMap(v.solids, "CaCOâ‚ƒ(s)", extent);
              recordReaction(v, {
                title: "Precipitation (CaCOâ‚ƒ)",
                tag: "PPT",
                eq: "CaClâ‚‚(aq) + Naâ‚‚COâ‚ƒ(aq) â†’ CaCOâ‚ƒ(s) + 2 NaCl(aq)",
                note: "Chalky white precipitate forms.",
                lr,
                extent,
              });
              SFX.precip();
              spawnPrecip(obj, 18, "chalk");
              did = true;
            }
          }

          return did;
        }

        // -------------------------
        // Effects (bubbles / precip / pour stream)
        // -------------------------
        function spawnBubbles(obj, n = 10) {
          if (!obj || !obj.fx) return;
          for (let i = 0; i < n; i++) {
            const b = document.createElement("div");
            b.className = "bubble";
            b.style.left = 40 + Math.random() * 80 + "%";
            b.style.bottom = 18 + Math.random() * 28 + "%";
            b.style.animationDelay = Math.random() * 0.2 + "s";
            b.style.width = 6 + Math.random() * 10 + "px";
            b.style.height = b.style.width;
            obj.fx.appendChild(b);
            setTimeout(() => b.remove(), 1400);
          }
        }

        function spawnPrecip(obj, n = 12, kind = "white") {
          if (!obj || !obj.fx) return;
          for (let i = 0; i < n; i++) {
            const p = document.createElement("div");
            p.className = "precip";
            p.style.left = 30 + Math.random() * 40 + "%";
            p.style.top = 35 + Math.random() * 15 + "%";
            p.style.width = 6 + Math.random() * 8 + "px";
            p.style.height = p.style.width;

            let col = "rgba(255,255,255,.92)";
            if (kind === "blue") col = "rgba(59,130,246,.88)";
            if (kind === "chalk") col = "rgba(245,245,245,.92)";
            p.style.background = col;
            p.style.border = "1px solid rgba(15,23,42,.12)";
            p.style.animationDelay = Math.random() * 0.18 + "s";
            obj.fx.appendChild(p);
            setTimeout(() => p.remove(), 1600);
          }
        }

        function showPourStream(fromX, fromY, toX, toY) {
          // stream in bench coords
          const dx = toX - fromX;
          const dy = toY - fromY;
          const len = Math.max(40, Math.hypot(dx, dy));
          const angle = (Math.atan2(dy, dx) * 180) / Math.PI + 90;

          stream.style.left = fromX + "px";
          stream.style.top = fromY + "px";
          stream.style.height = len + "px";
          stream.style.transform = `translate(-50%, 0) rotate(${angle}deg)`;
          stream.classList.remove("show");
          // force reflow
          stream.offsetHeight;
          stream.classList.add("show");
        }

        // -------------------------
        // Applying chemicals
        // -------------------------
        function updateSafety(v) {
          const ph = computePH(v);
          const hazard = ph < 3.0 || ph > 11.0;
          warnDot.style.opacity = hazard ? "1" : ".35";
          warnText.textContent = hazard ? "CAUTION" : "OK";
        }

        function updateHUD(obj) {
          if (!obj || !obj.isVessel) {
            selTempLabel.textContent = "â€”";
            phVal.textContent = "â€”";
            phBar.style.width = "0%";
            tempDot.style.opacity = ".35";
            updateSafety({ aq: {}, volumeL: 0.25 });
            return;
          }

          const v = obj.vessel;
          selTempLabel.textContent = `${Math.round(v.tempC)}Â°C`;
          tempDot.style.opacity = "1";

          const ph = computePH(v);
          phVal.textContent = ph.toFixed(2);
          phBar.style.width = `${(ph / 14) * 100}%`;

          // dot color logic (acid->pink, neutral->green, base->blue)
          if (ph < 6.3) {
            selDot.style.background = "rgba(255,45,85,.95)";
          } else if (ph > 7.7) {
            selDot.style.background = "rgba(59,130,246,.95)";
          } else {
            selDot.style.background = "rgba(52,211,153,.95)";
          }

          updateSafety(v);
        }

        function applyArmedToSelected({ via = "apply" } = {}) {
          const obj = state.objects.get(state.selectedId);
          if (!obj || !obj.isVessel) {
            SFX.error();
            toast("Select a vessel first");
            return;
          }
          if (!state.armed) {
            SFX.error();
            toast("Arm a chemical first");
            return;
          }

          const chem = state.armed;
          const v = obj.vessel;
          const mol = chem.addMol * state.dose;

          // Pour stream animation: from top-center of vessel down into it
          const benchRect = bench.getBoundingClientRect();
          const vesselRect = obj.el.getBoundingClientRect();
          const fromX = vesselRect.left + vesselRect.width / 2 - benchRect.left;
          const fromY = vesselRect.top - 10 - benchRect.top;
          const toX = vesselRect.left + vesselRect.width / 2 - benchRect.left;
          const toY = vesselRect.top + vesselRect.height * 0.45 - benchRect.top;
          showPourStream(fromX, fromY, toX, toY);

          // Special: indicator
          if (chem.id === "Phen") {
            v.hasPhen = true;
            addToMap(v.aq, "Phen", mol);
            SFX.pour();
            log("Added indicator", `Phenolphthalein â†’ ${obj.label}`);
            toast("Phenolphthalein added (pink in base)");
            v.level = clamp(v.level + 0.02, 0.08, 0.92);
            updateVesselVisual(obj);
            updateHUD(obj);
            renderPanelContents();
            renderReactionsList();
            return;
          }

          // Add ionic contributions
          const contrib = ionicContrib(chem.id, mol);
          for (const [k, val] of Object.entries(contrib.aq)) {
            addToMap(v.aq, k, val);
          }

          // Tint blend
          if (contrib.tint) {
            v.tint = mixTint(v.tint, contrib.tint, 0.35);
          } else {
            v.tint = mixTint(v.tint, { r: 39, g: 174, b: 96, a: 0.1 }, 0.1);
          }

          // volume/level
          v.level = clamp(v.level + 0.06, 0.08, 0.92);

          SFX.pour();
          log(
            "Added reagent",
            `${chem.formula} â†’ ${obj.label} (${fmtMol(mol)} mol)`,
          );
          toast(`${chem.formula} added to ${obj.label}`);

          // Run reactions
          runReactions(v, obj);

          updateVesselVisual(obj);
          updateHUD(obj);
          renderPanelContents();
          renderReactionsList();
        }

        btnApply.addEventListener("click", () => {
          SFX.click();
          applyArmedToSelected({ via: "apply" });
          if (!panelOpen) setPanelOpen(true); // helpful auto-open
        });

        // -------------------------
        // Stirring + Heating
        // -------------------------
        btnStir.addEventListener("click", () => {
          SFX.stir();
          const obj = state.objects.get(state.selectedId);
          if (!obj || !obj.isVessel) {
            toast("Select a vessel to stir");
            SFX.error();
            return;
          }
          const v = obj.vessel;
          v.tint = mixTint(v.tint, { r: 39, g: 174, b: 96, a: 0.1 }, 0.08);
          runReactions(v, obj);
          updateVesselVisual(obj);
          updateHUD(obj);
          renderPanelContents();
          renderReactionsList();
          spawnBubbles(obj, 8);
          log("Stirred", `Mixed contents in ${obj.label}`);
          toast("Stirring complete");
        });

        function nearestBurner(dist = 220) {
          const sel = state.objects.get(state.selectedId);
          if (!sel || !sel.isVessel) return null;

          let best = null,
            bestD = Infinity;
          for (const o of state.objects.values()) {
            if (o.type !== "burner") continue;
            const d = Math.hypot(o.x - sel.x, o.y - sel.y);
            if (d < dist && d < bestD) {
              best = o;
              bestD = d;
            }
          }
          return best;
        }

        function toggleBurner(burnerObj) {
          burnerObj.burnerOn = !burnerObj.burnerOn;
          burnerObj.el.classList.toggle("on", burnerObj.burnerOn);
          if (burnerObj.burnerOn) {
            SFX.flameOn();
            toast("Burner ignited");
            log("Burner", "Ignited");
          } else {
            SFX.flameOff();
            toast("Burner off");
            log("Burner", "Extinguished");
          }
        }

        btnIgnite.addEventListener("click", () => {
          SFX.click();
          const burnerObj = nearestBurner();
          if (!burnerObj) {
            toast("Place a burner near your vessel (drag it under)");
            SFX.error();
            return;
          }
          toggleBurner(burnerObj);
        });

        // Heat loop
        setInterval(() => {
          const sel = state.objects.get(state.selectedId);
          if (!sel || !sel.isVessel) return;

          const burner = nearestBurner();
          if (!burner || !burner.burnerOn) return;

          const d = Math.hypot(burner.x - sel.x, burner.y - sel.y);
          if (d > 190) return;

          const rate = clamp((190 - d) / 190, 0.08, 0.85);
          sel.vessel.tempC = clamp(sel.vessel.tempC + 0.35 * rate, 0, 100);

          if (sel.vessel.tempC > 60 && Math.random() < 0.22) {
            spawnBubbles(sel, 6);
            if (audioOn && Math.random() < 0.1)
              noise({ dur: 0.12, gain: 0.02, tone: 500 });
          }

          updateHUD(sel);
          updateVesselVisual(sel);
          renderPanelContents();
        }, 220);

        // -------------------------
        // Panel rendering
        // -------------------------
        function renderPanelContents() {
          const obj = state.objects.get(state.selectedId);
          contentsRows.innerHTML = "";

          if (!obj || !obj.isVessel) {
            contentsHint.style.display = "block";
            return;
          }
          contentsHint.style.display = "none";

          const v = obj.vessel;
          const entries = [];

          for (const [sp, mol] of Object.entries(v.aq)) {
            entries.push({
              sp,
              mol,
              state: "aq",
              note: sp === "H+" ? "acid" : sp === "OH-" ? "base" : "",
            });
          }
          for (const [sp, mol] of Object.entries(v.solids)) {
            entries.push({ sp, mol, state: "s", note: "precipitate" });
          }
          for (const [sp, mol] of Object.entries(v.gas)) {
            entries.push({ sp, mol, state: "g", note: "gas" });
          }

          if (!entries.length) {
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
            <div class="chem">â€”</div>
            <div class="right">0</div>
            <div class="right">â€”</div>
            <div class="right">Empty</div>
          `;
            contentsRows.appendChild(row);
            return;
          }

          const order = { aq: 1, s: 2, g: 3 };
          entries.sort(
            (a, b) =>
              order[a.state] - order[b.state] || a.sp.localeCompare(b.sp),
          );

          for (const e of entries.slice(0, 16)) {
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
            <div class="chem">${escapeHtml(e.sp)}</div>
            <div class="right">${escapeHtml(fmtMol(e.mol))}</div>
            <div class="right">${escapeHtml(e.state)}</div>
            <div class="right">${escapeHtml(e.note || "")}</div>
          `;
            contentsRows.appendChild(row);
          }

          updateHUD(obj);
        }

        function renderReactionsList() {
          const obj = state.objects.get(state.selectedId);
          rxnList.innerHTML = "";

          if (!obj || !obj.isVessel) {
            rxnList.innerHTML = `<div class="rxnItem"><div class="rxnTitle">Select a vessel</div><div class="rxnNote">Reactions will appear here.</div></div>`;
            return;
          }

          const v = obj.vessel;
          if (!v.reactions.length) {
            rxnList.innerHTML = `
            <div class="rxnItem">
              <div class="rxnTitle">Ready <span class="rxnTag">LIVE</span></div>
              <div class="rxnEq">Try: HCl + NaHCOâ‚ƒ (fizz), AgNOâ‚ƒ + NaCl (white ppt), CuSOâ‚„ + NaOH (blue ppt).</div>
              <div class="rxnNote">Equations update automatically when conditions are met.</div>
            </div>
          `;
            return;
          }

          v.reactions.slice(0, 8).forEach((r) => {
            const item = document.createElement("div");
            item.className = "rxnItem";
            item.innerHTML = `
            <div class="rxnTitle">${escapeHtml(r.title)} <span class="rxnTag">${escapeHtml(r.tag || "RXN")}</span></div>
            <div class="rxnEq">${escapeHtml(r.eq)}</div>
            <div class="rxnNote">${escapeHtml(r.note || "")}</div>
            <div class="rxnMini">
              <span class="pill">Limiting: <b>${escapeHtml(r.lr || "â€”")}</b></span>
              <span class="pill">Extent: <b>${escapeHtml(fmtMol(r.extent || 0))}</b> mol</span>
            </div>
          `;
            rxnList.appendChild(item);
          });
        }

        // -------------------------
        // Chemistry list
        // -------------------------
        function renderChemList() {
          chemList.innerHTML = "";
          const groups = [
            { title: "Solvent", filter: (c) => c.kind === "solvent" },
            { title: "Strong acids", filter: (c) => c.kind.startsWith("acid") },
            { title: "Strong bases", filter: (c) => c.kind.startsWith("base") },
            {
              title: "Salts (precipitation)",
              filter: (c) => c.kind === "salt",
            },
            { title: "Carbonates", filter: (c) => c.kind === "bicarb" },
            { title: "Indicators", filter: (c) => c.kind === "indicator" },
          ];

          for (const g of groups) {
            const header = document.createElement("div");
            header.style.margin = "8px 0 6px";
            header.style.fontSize = "11px";
            header.style.color = "rgba(15,23,42,.55)";
            header.style.letterSpacing = ".35px";
            header.style.fontWeight = "800";
            header.textContent = g.title.toUpperCase();
            chemList.appendChild(header);

            CHEM.filter(g.filter).forEach((c) => {
              const btn = document.createElement("div");
              btn.className = "chemBtn";
              btn.dataset.id = c.id;
              btn.innerHTML = `
              <div class="lefty">
                <div class="nm">${escapeHtml(c.name)}</div>
                <div class="fx">${escapeHtml(c.formula)} â€¢ add ${fmtMol(c.addMol)} mol</div>
              </div>
              <div class="tag">${escapeHtml(c.tag || "chem")}</div>
            `;
              btn.addEventListener("click", () => setArmed(c));
              chemList.appendChild(btn);
            });
          }
        }

        // -------------------------
        // Tools
        // -------------------------
        function renderTools() {
          toolGrid.innerHTML = "";
          TOOLS.forEach((t) => toolGrid.appendChild(createToolCard(t)));
        }

        // -------------------------
        // Tabs
        // -------------------------
        tabs.forEach((t) => {
          t.addEventListener("click", () => {
            tabs.forEach((x) => x.classList.remove("is-active"));
            t.classList.add("is-active");
            const name = t.dataset.tab;
            if (name === "contents") {
              tabContents.classList.remove("is-hidden");
              tabReactions.classList.add("is-hidden");
            } else {
              tabReactions.classList.remove("is-hidden");
              tabContents.classList.add("is-hidden");
            }
            SFX.click();
            if (!panelOpen) setPanelOpen(true);
          });
        });

        // -------------------------
        // Dose
        // -------------------------
        function setDose(v) {
          state.dose = clamp(Math.round(v * 100) / 100, 0.1, 9.99);
          doseVal.textContent = state.dose.toFixed(2);
        }
        dosePlus.addEventListener("click", () => {
          SFX.click();
          setDose(state.dose + 0.1);
        });
        doseMinus.addEventListener("click", () => {
          SFX.click();
          setDose(state.dose - 0.1);
        });

        // -------------------------
        // Reset
        // -------------------------
        function resetAll() {
          for (const o of state.objects.values()) {
            if (o.el && o.el.parentNode) o.el.remove();
          }
          state.objects.clear();
          state.selectedId = null;
          setArmed(null);
          renderPanelContents();
          renderReactionsList();
          selVesselLabel.textContent = "None";
          selTempLabel.textContent = "â€”";
          phVal.textContent = "â€”";
          phBar.style.width = "0%";
          warnDot.style.opacity = ".35";
          warnText.textContent = "OK";
          applyInfo.textContent = "Select a vessel";
          btnApply.disabled = true;
          btnApply.style.opacity = ".6";
          log("Reset", "Lab cleared");
          toast("Lab reset");
          SFX.place();
        }
        btnReset.addEventListener("click", () => {
          SFX.click();
          resetAll();
        });

        // -------------------------
        // Apply by clicking vessel
        // -------------------------
        // (Already wired in buildObject -> if vessel clicked and armed, it pours)

        // -------------------------
        // Init
        // -------------------------
        function init() {
          renderTools();
          renderChemList();
          setDose(1.0);
          refreshApplyInfo();
          renderPanelContents();
          renderReactionsList();
          setPanelOpen(true);
          toast("Drag a beaker to the bench to begin");
          log(
            "Tip",
            "Collapse the black panel using the Lab Panel button, then open anytime.",
          );
        }
        init();
      })();
    </script>
  </body>
</html>
